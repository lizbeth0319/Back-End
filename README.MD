# Sistema de GestiÃ³n de Aprendices - Backend

## ğŸ“‹ DescripciÃ³n del Proyecto

Backend API desarrollado con **Node.js** y **Express** para un sistema integral de gestiÃ³n de aprendices en una instituciÃ³n educativa. La aplicaciÃ³n permite la administraciÃ³n de usuarios (aprendices, instructores, enfermerÃ­a y porterÃ­a), autenticaciÃ³n segura, generaciÃ³n de documentos PDF y gestiÃ³n de permisos.

## ğŸ¯ CaracterÃ­sticas Principales

- âœ… AutenticaciÃ³n y autorizaciÃ³n con JWT
- âœ… GestiÃ³n de usuarios con diferentes roles
- âœ… Sistema completo de aprendices (crear, leer, actualizar, eliminar)
- âœ… BÃºsqueda avanzada de aprendices por mÃºltiples criterios
- âœ… GestiÃ³n de permisos y autorizaciones
- âœ… GeneraciÃ³n de documentos PDF
- âœ… Carga y almacenamiento de imÃ¡genes en Cloudinary
- âœ… ValidaciÃ³n de datos con express-validator
- âœ… Manejo seguro de contraseÃ±as con bcryptjs
- âœ… CORS habilitado para comunicaciÃ³n con frontend

## ğŸ› ï¸ TecnologÃ­as Utilizadas

| TecnologÃ­a | VersiÃ³n | PropÃ³sito |
|-----------|---------|----------|
| Node.js | 16+ | Runtime de JavaScript |
| Express | 5.1.0 | Framework web |
| Mongoose | 8.18.1 | ODM para MongoDB |
| MongoDB Atlas | - | Base de datos en la nube |
| JWT | 9.0.2 | AutenticaciÃ³n token-based |
| bcryptjs | 3.0.2 | EncriptaciÃ³n de contraseÃ±as |
| Cloudinary | 2.7.0 | Almacenamiento de imÃ¡genes |
| PDFMake | 0.2.20 | GeneraciÃ³n de PDFs |
| Nodemailer | 7.0.9 | EnvÃ­o de correos |
| CORS | 2.8.5 | Control de solicitudes entre dominios |

## ğŸ“‹ Requisitos Previos

Antes de comenzar, asegÃºrate de tener instalado:

- **Node.js** (v16 o superior)
- **npm** (gestor de paquetes)
- **MongoDB Atlas** (cuenta y base de datos configurada)
- **Cloudinary** (cuenta para almacenamiento de imÃ¡genes)
- Variables de entorno configuradas

## ğŸš€ InstalaciÃ³n

### 1. Clonar o descargar el proyecto
```bash
git clone <url-del-repositorio>
cd Backend
```

### 2. Instalar dependencias
```bash
npm install
```

### 3. Configurar variables de entorno

Crea un archivo `.env` en la raÃ­z del proyecto con las siguientes variables:

```env
# Puerto del servidor
PORT=3000

# Base de datos MongoDB
MONGODB_URI=mongodb+srv://<usuario>:<contraseÃ±a>@<cluster>.mongodb.net/<nombre-db>

# Cloudinary
CLOUDINARY_NAME=<tu-cloud-name>
CLOUDINARY_KEY=<tu-api-key>
CLOUDINARY_SECRET=<tu-api-secret>

# JWT
JWT_SECRET=<tu-clave-secreta-jwt>
JWT_EXPIRE=7d
```

### 4. Ejecutar el servidor

**Desarrollo:**
```bash
node app.js
```

**Con nodemon (recomendado para desarrollo):**
```bash
npx nodemon app.js
```

El servidor estarÃ¡ disponible en: `http://localhost:3000`

## ğŸ“ Estructura del Proyecto

```
Backend/
â”œâ”€â”€ app.js                    # Archivo principal de la aplicaciÃ³n
â”œâ”€â”€ package.json              # Dependencias del proyecto
â”œâ”€â”€ README.md                 # Este archivo
â”‚
â”œâ”€â”€ config/                   # Configuraciones
â”‚   â”œâ”€â”€ db-atlas.js          # ConexiÃ³n MongoDB Atlas
â”‚   â”œâ”€â”€ db-compass.js        # ConexiÃ³n MongoDB Compass (local)
â”‚   â””â”€â”€ cloudinary.js        # ConfiguraciÃ³n de Cloudinary
â”‚
â”œâ”€â”€ controllers/              # Controladores (lÃ³gica de negocio)
â”‚   â”œâ”€â”€ Authentication.js    # AutenticaciÃ³n y registro
â”‚   â”œâ”€â”€ User.js              # GestiÃ³n de usuarios
â”‚   â”œâ”€â”€ Aprendiz.js          # GestiÃ³n de aprendices
â”‚   â”œâ”€â”€ Permiso.js           # GestiÃ³n de permisos
â”‚   â””â”€â”€ Estado.js            # GestiÃ³n de estados
â”‚
â”œâ”€â”€ models/                   # Esquemas MongoDB
â”‚   â”œâ”€â”€ User.js              # Modelo de usuario
â”‚   â”œâ”€â”€ Aprendiz.js          # Modelo de aprendiz
â”‚   â””â”€â”€ Permiso.js           # Modelo de permiso
â”‚
â”œâ”€â”€ routers/                  # Rutas de la API
â”‚   â”œâ”€â”€ Authentication.js    # Rutas de autenticaciÃ³n
â”‚   â”œâ”€â”€ User.js              # Rutas de usuarios
â”‚   â”œâ”€â”€ Aprendiz.js          # Rutas de aprendices
â”‚   â”œâ”€â”€ Permiso.js           # Rutas de permisos
â”‚   â””â”€â”€ Estado.js            # Rutas de estados
â”‚
â”œâ”€â”€ middleware/               # Middleware de Express
â”‚   â”œâ”€â”€ generar-jwt.js       # GeneraciÃ³n de tokens JWT
â”‚   â”œâ”€â”€ validar-jwt.js       # ValidaciÃ³n de tokens JWT
â”‚   â”œâ”€â”€ validar-campo.js     # ValidaciÃ³n de campos
â”‚   â””â”€â”€ validar-rol.js       # ValidaciÃ³n de roles
â”‚
â”œâ”€â”€ helpers/                  # Funciones auxiliares
â”‚   â”œâ”€â”€ Authentication.js    # Helpers de autenticaciÃ³n
â”‚   â”œâ”€â”€ User.js              # Helpers de usuarios
â”‚   â”œâ”€â”€ Permiso.js           # Helpers de permisos
â”‚   â”œâ”€â”€ Aprendiz.js          # Helpers de aprendices
â”‚   â””â”€â”€ pdf-services/        # GeneraciÃ³n de PDFs
â”‚       â”œâ”€â”€ generate-pdf.js
â”‚       â”œâ”€â”€ pdf-template.js
â”‚       â”œâ”€â”€ styles.js
â”‚       â”œâ”€â”€ fonts.js
â”‚       â””â”€â”€ get-base64.js
â”‚
â”œâ”€â”€ img-sign/                 # ImÃ¡genes de firmas almacenadas localmente
â””â”€â”€ public/                   # Archivos estÃ¡ticos
    â””â”€â”€ index.html
```

## ğŸ” Roles y Acceso

El sistema cuenta con los siguientes roles de usuario:

| Rol | DescripciÃ³n |
|-----|-------------|
| **aprendiz** | Estudiante que puede ver sus documentos y permisos |
| **instructor** | Docente que gestiona aprendices y genera documentos |
| **enfermeria** | Personal de salud con acceso a registros de salud |
| **porteria** | Personal de entrada que valida accesos |

## ğŸ“¡ Endpoints Principales

### ğŸ”‘ AutenticaciÃ³n

```
POST /api/register
- Crear nuevo usuario
- Body: { nombre, email, password, rol, imagen(opcional) }

POST /api/login
- Iniciar sesiÃ³n
- Body: { email, password }
- Response: { usuario, token }
```

### ğŸ‘¥ Usuarios

```
GET /api/user/obtenerusuarios
- Obtener todos los usuarios (requiere JWT)

GET /api/user/obtenerusuario/:id
- Obtener usuario especÃ­fico (requiere JWT)

PUT /api/user/actualizarusuario/:id
- Actualizar datos de usuario (requiere JWT)

DELETE /api/user/eliminarprograma/:id
- Eliminar usuario (requiere JWT)
```

### ğŸ“ Aprendices

```
POST /api/aprendiz/crearaprendiz
- Crear nuevo aprendiz (requiere JWT)
- Body: { nombre, ficha, programa, email, tipo_programa }

GET /api/aprendiz/obteneraprendices
- Obtener todos los aprendices (requiere JWT)

GET /api/aprendiz/obteneraprendiz/:nombre
- Buscar aprendiz por nombre (requiere JWT)

GET /api/aprendiz/aprendices/search?nombre=&ficha=&programa=
- BÃºsqueda avanzada de aprendices con mÃºltiples filtros (requiere JWT)

PUT /api/aprendiz/actualizaraprendiz/:id
- Actualizar datos de aprendiz (requiere JWT)

DELETE /api/aprendiz/eliminarprograma/:id
- Eliminar aprendiz (requiere JWT)
```

### ğŸ”’ Permisos

```
POST /api/permiso/crearPermiso
- Crear nuevo permiso (requiere JWT)

GET /api/permiso/obtenerpermisos
- Obtener todos los permisos (requiere JWT)

GET /api/permiso/obtenerpermiso/:id
- Obtener permiso especÃ­fico (requiere JWT)

PUT /api/permiso/actualizarpermiso/:id
- Actualizar permiso (requiere JWT)

DELETE /api/permiso/eliminarpermiso/:id
- Eliminar permiso (requiere JWT)
```

## ğŸ” Ejemplos de Uso

### Registrar un Usuario

```bash
curl -X POST http://localhost:3000/api/register \
  -H "Content-Type: application/json" \
  -d '{
    "nombre": "Juan PÃ©rez",
    "email": "juan@example.com",
    "password": "password123",
    "rol": "aprendiz"
  }'
```

### Iniciar SesiÃ³n

```bash
curl -X POST http://localhost:3000/api/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "juan@example.com",
    "password": "password123"
  }'
```

### Crear un Aprendiz (requiere token JWT)

```bash
curl -X POST http://localhost:3000/api/aprendiz/crearaprendiz \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <tu_token_jwt>" \
  -d '{
    "nombre": "Carlos",
    "ficha": "2458123",
    "programa": "TÃ©cnico en Salud",
    "email": "carlos@example.com",
    "tipo_programa": "Presencial"
  }'
```

### Buscar Aprendices con Filtros

```bash
curl -X GET "http://localhost:3000/api/aprendiz/aprendices/search?nombre=Carlos&ficha=2458123" \
  -H "Authorization: Bearer <tu_token_jwt>"
```

## ğŸ“ Funciones Importantes

### obtenerAprendicesSearch()

FunciÃ³n ubicada en `/controllers/Aprendiz.js` que permite buscar aprendices con mÃºltiples criterios de filtrado.

**ExplicaciÃ³n de componentes:**

- **$or**: Operador lÃ³gico que devuelve documentos que cumplan **cualquiera** de las condiciones
- **{ campo: regex }**: Estructura para cada condiciÃ³n en la consulta
- **campo**: Nombre del campo en la base de datos (nombre, ficha, programa)
- **regex**: ExpresiÃ³n regular para bÃºsqueda flexible en cadenas de texto
- **[...]**: Array de condiciones evaluadas con $or

**Ejemplo de consulta:**
```javascript
db.aprendices.find({
  $or: [
    { nombre: /Carlos/i },
    { ficha: /2458123/i },
    { programa: /Salud/i }
  ]
})
```

## ğŸ” Seguridad

- âœ… ContraseÃ±as encriptadas con bcryptjs
- âœ… AutenticaciÃ³n mediante JWT (JSON Web Tokens)
- âœ… ValidaciÃ³n de campos en todas las rutas
- âœ… CORS configurado para controlar accesos
- âœ… Variables de entorno para datos sensibles
- âœ… ValidaciÃ³n de roles para rutas protegidas

## ğŸ“¦ Dependencias Principales

```json
{
  "express": "5.1.0",
  "mongoose": "8.18.1",
  "jsonwebtoken": "9.0.2",
  "bcryptjs": "3.0.2",
  "express-validator": "7.2.1",
  "cloudinary": "2.7.0",
  "pdfmake": "0.2.20",
  "nodemailer": "7.0.9",
  "cors": "2.8.5",
  "dotenv": "17.2.2"
}
```

## ğŸ› SoluciÃ³n de Problemas

### Error de conexiÃ³n a MongoDB
- Verifica que la URI en `.env` sea correcta
- AsegÃºrate de estar conectado a internet
- Valida que tu IP estÃ© en la lista blanca de MongoDB Atlas

### Error de autenticaciÃ³n JWT
- Verifica que el token sea vÃ¡lido y no haya expirado
- Revisa que la cabecera `Authorization` incluya `Bearer <token>`

### Errores de Cloudinary
- Verifica que las credenciales en `.env` sean correctas
- AsegÃºrate de que la imagen cumpla los requisitos de tamaÃ±o

## ğŸ‘¨â€ğŸ’» Desarrollo

### Estructura de archivos recomendada para agregar nuevas funcionalidades

1. **Crear el modelo** en `models/`
2. **Crear el controller** en `controllers/`
3. **Crear helpers** en `helpers/` si es necesario
4. **Crear las rutas** en `routers/`
5. **Agregar validaciones** con middleware

## ğŸ“ Soporte

Para reportar problemas o sugerencias, contÃ¡ctate con el equipo de desarrollo.

---

**Ãšltima actualizaciÃ³n:** Diciembre 2025
**VersiÃ³n:** 1.0.0